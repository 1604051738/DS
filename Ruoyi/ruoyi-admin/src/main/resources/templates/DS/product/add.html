<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head id="1">
    <meta http-equiv="Content-Type" content="multipart/form-data; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
    <th:block th:include="include :: header('新增商品')" />
    <th:block th:include="include :: select2-css" />
    <th:block th:include="include :: bootstrap-select-css" />
    <th:block th:include="include :: summernote-css" />
    <style type="text/css">
        .show-grid{
            margin: 0px 0;
            border: 0px;
        }
        .modal{
            position: absolute !important;
            z-index: 0 !important;
        }
    </style>
</head>
<body class="white-bg" id="2">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <div class="col-sm-12">
            <div class="ibox float-e-margins border-0">
                <div class="ibox-title">
                    <h5>商品基本信息</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up" id="fa" onclick="COWindow()"></i>
                        </a>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content text-center h-200" id="CO">
                    <span id="sparkline7">
                        <form class="form-horizontal m" id="form-product-add">

                            <div class="row show-grid ">
                                <div class="col-md-6">
                                <label class="col-sm-2 control-label">目录分类：</label>
                                <div class="col-sm-7">
                                    <select name="category" class="form-control m-b" id="category">
                                        <option value="">------</option>
                                    </select>
                                </div>
                                <a class="btn btn-success col-sm-1" title="创建新的目录分类" onclick="layerOpenCategory()" ><i class="fa fa-plus"></i></a>
                                </div>

                                <div class="col-md-6">
                                <label class="col-sm-2 control-label">供应商：</label>
                                <div class="col-sm-7">
                                    <select name="supplier" class="form-control m-b" id="supplier">
                                        <option value="">------</option>
                                    </select>
                                </div>
                                <a class="btn btn-success col-sm-1" title="创建新的供应商" onclick="layerOpenSupplier()" ><i class="fa fa-plus"></i></a>
                                </div>
                            </div>

                            <div class="row show-grid">
                                <div class="col-md-12">
                                    <label class="col-sm-1 control-label"><span style="color: red; ">*</span>中文名称：</label>
                                    <div class="col-sm-10" >
                                        <input name="chinesename" id="chinesename" class="form-control" type="text" style="border-radius:9px" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row show-grid">
                            <div class="col-md-12">
                                    <label class="col-sm-1 control-label">英文名称：</label>
                                    <div class="col-sm-10" >
                                        <input name="englishname" id="englishname" class="form-control" type="text" style="border-radius:9px">
                                    </div>
                                </div>
                            </div>
                            <div class="row show-grid">
                                <div class="col-md-6">
                                    <label class="col-sm-2 control-label">报关名称中文：</label>
                                    <div class="col-sm-8" >
                                        <input name="nocdc" id="nocdc" class="form-control" type="text" style="border-radius:9px">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="col-sm-2 control-label">报关名称英文：</label>
                                    <div class="col-sm-8" >
                                        <input name="nocde" id="nocde" class="form-control" type="text" style="border-radius:9px">
                                    </div>
                                </div>
                            </div>


                        <div class="row show-grid">
                            <div class="col-md-6">
                                <label class="col-sm-2 control-label"><span style="color: red; ">*</span>编码：</label>
                                <div class="col-sm-8">
                                    <input name="code" id="code" class="form-control" type="text" style="border-radius:9px" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                    <label class="col-sm-2 control-label">外部编码：</label>
                                    <div class="col-sm-8" >
                                        <input name="ocode" id="ocode" class="form-control" type="text" style="border-radius:9px">
                                    </div>
                            </div>
                        </div>

                        <div class="row show-grid">
                            <div class="col-md-12">
                                    <label class="col-sm-1 control-label">关键字：</label>
                                    <div class="col-sm-10" >
                                        <input name="keyword" id="keyword" class="form-control" type="text" style="border-radius:9px">
                                    </div>
                            </div>
                        </div>

                        <div class="row show-grid">
                            <div class="col-md-12">
                            <label class="col-md-1 control-label">详细描述：</label>
                            <div class="col-md-10" id="message" >
                                <textarea name="dd" id="dd" class="form-control" rows="10" style="border-radius:9px"></textarea>
                            </div>
                            </div>
                        </div>
                        </form>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="wrapper wrapper-content animated fadeInRight ibox-content" id="skubody">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>SKU单品</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-down" id="fa1" onclick="CO1Window()"></i>
                        </a>
                        <a>
                        <i class="fa fa-plus" id="sku"></i>
                        </a>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content text-center h-200" id="CO1" style="display: none">
                    <span id="sparkline8">
                    </span>
                </div>
            </div>
        </div>
    </div>




    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>商品图片</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up" id="fa2" onclick=""></i>
                        </a>
                        <a>
                            <i class="fa fa-plus" id="fa3" onclick=""></i>
                        </a>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content text-center h-200" id="CO2">
                    <span id="sparkline9">
                        <h4 style="color: #2e2d3c">将以第一张作为商品预览图</h4>
                            <ul id="ul-img">
                            <li class="row" id="hang1" name="none">
                                    <div class="col-md-5">
                                        <label class="col-sm-3 control-label" >图片路径：</label>
                                        <div class="col-sm-6">
                                            <input  name="filePath" class="form-control" type="file" onchange="viewImage('hang1')" style="border-radius:9px">
                                        </div>
                                    </div>
                                    <div class="col-md-5">
                                        <label class="col-sm-3 control-label" >图片预览：</label>
                                        <div class="col-sm-6">
                                            <img src="" height="50" alt="Image preview area..." title="preview-img" width="50">
                                        </div>
                                    </div>
                                    <div id="table-td" class="col-md-2">
                                        <a class="close-link"><i class="fa fa-times" onclick="closeImg('hang1')"></i></a>
                                    </div>
                            </li>
                            </ul>
                        </table>
                    </span>
                </div>
            </div>
        </div>
    </div>


<!--    sku单品添加表单-->
    <div style="display: none" id="sku-div">
        <form class="form-horizontal m" style="display: block" enctype="multipart/form-data">
            <hr>
            <div class="row show-grid">
                <div class="col-sm-6">
                <label class="col-sm-3 control-label">sku图片预览：</label>
                <div class="col-md-6">
                    <img src="" height="200" width="200" alt="Image preview area..." title="preview-img" class="onimg">
                </div>
                </div>
                <div class="col-sm-6" name="appendObj">

                </div>
            </div>

        <div class="row show-grid">
            <div class="col-md-3">
            <label class="col-sm-3 control-label">size：</label>
            <div class="col-md-6">
                <input name="size" id="size" class="form-control" type="text" style="border-radius:9px">
            </div>
            </div>
            <div class="col-md-3">
            <label class="col-md-3 control-label">颜色：</label>
            <div class="col-md-6">
                <input name="color" id="color" class="form-control" type="text" style="border-radius:9px">
            </div>
            </div>
            <div class="col-md-3">
                <label class="col-sm-3 control-label">净重：</label>
                <div class="col-sm-6">
                    <input name="suttle" id="suttle" class="form-control" type="text" style="border-radius:9px">
                </div>
            </div>
            <div class="col-md-3">
                <label class="col-sm-3 control-label"><span style="color: red; ">*</span>毛重：</label>
                <div class="col-sm-6">
                    <input name="rw" id="rw" class="form-control" type="text" style="border-radius:9px" required>
                </div>
            </div>
        </div>




        <div class="row show-grid">
            <div class="col-md-3">
            <label class="col-sm-3 control-label"><span style="color: red; ">*</span>成本价(RMB)：</label>
            <div class="col-sm-6">
                <input name="costprice" id="costprice" class="form-control" type="text" style="border-radius:9px" required>
            </div>
            </div>
            <div class="col-md-3">
            <label class="col-sm-3 control-label">售价：</label>
            <div class="col-sm-6">
                <input name="sellprice" id="sellprice" class="form-control" type="text" style="border-radius:9px">
            </div>
            </div>
            <div class="col-md-3">
                <label class="col-sm-3 control-label"><span style="color: red; ">*</span>状态：</label>
                <div class="col-sm-6">
                    <select name="state" id="state" class="form-control m-b" style="border-radius:9px" required>
                        <option value="1" selected>激活</option>
                        <option value="0">非激活</option>
                        <option value="2">售完即止</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <label class="col-sm-3 control-label">SKU映射：</label>
                <div class="col-sm-6">
                    <input name="skumap" id="skumap" class="form-control" type="text" style="border-radius:9px">
                </div>
            </div>
        </div>





        <div class="row show-grid">
            <div class="col-md-4">
                 <label class="col-sm-3 control-label"><span style="color: red;">*</span>库存刊登策略：</label>
                  <div class="col-sm-6">
                        <select name="ips" id="ips" class="form-control m-b" required>
                            <option value=\"1\" selected>默认</option>
                            <option value="2">按可售量</option>
                       </select>
                   </div>
            </div>
            <div class="col-md-4">
            <label class="col-sm-3 control-label">采购交期：</label>
            <div class="col-sm-6">
                <input name="pd" id="pd" class="form-control" type="text" style="border-radius:9px">
            </div>
            </div>
            <div class="col-md-4">
            <label class="col-sm-3 control-label">统计时间：</label>
            <div class="col-sm-6">
                <div class="input-group date">
                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                    <input type="text" class="form-control datepicker hasDatepicker" id="stt" placeholder="yyyy-MM-dd" name="stt" data-format="yyyy-MM" style="border-radius:9px"/>
                </div>
            </div>
            </div>
        </div>



        <div class="row show-grid">
            <div class="col-md-4">
            <label class="col-sm-3 control-label">长：</label>
            <div class="col-sm-2">
                <input name="length" id="length" class="form-control" type="text" style="border-radius:9px">
            </div>
            </div>
            <div class="col-md-4">
                <label class="col-sm-3 control-label">宽：</label>
                <div class="col-sm-2">
                    <input name="width" id="width" class="form-control" type="text" style="border-radius:9px">
                </div>
            </div>

            <div class="col-md-4">
                <label class="col-sm-3 control-label">高：</label>
                <div class="col-sm-2">
                    <input name="height" id="height" class="form-control" type="text" style="border-radius:9px">
                </div>
            </div>

        </div>
            <hr>
    </form>
    </div>



    <div class="btn-group clearfix show-xs save-group col-xs-12" style="position: fixed; margin-left: -10px; right: 10px;  bottom: 10px; width: 20% ">
        <div class="col-sm-offset-5 col-sm-10">
            <button type="button" class="default btn btn-primary hide-xs" onclick="submitHandler()"><i class="fa fa-check"></i>保 存</button>&nbsp;
            <button type="button" class="btn btn-default" onclick="closeItem()"><i class="fa fa-reply-all"></i>关 闭 </button>
        </div>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: select2-js" />
    <th:block th:include="include :: bootstrap-select-js" />
    <th:block th:include="include :: sparkline-js" />
    <th:block th:include="include :: summernote-js" />
    <th:block th:include="include :: datetimepicker-js" />

    <script type="text/javascript" src="/js/plugins/Sortable.min.js"></script>
    <script type="text/javascript">
        $().ready(function () {
                $('#dd').summernote({
                    lang: 'zh-CN',
                    height: 400
                });
                $("#category").one("click", refresh());
                $("#sku-div select").select2("destroy");
            })


        function viewImage(liid) {
            // 获取FileList的第一个元素
            liid = liid.toString().replace(/"/g,'');
            var f = $('#'+liid+' input[name = filePath]')[0].files[0];
            if(typeof (f) == 'undefined'){
                return false;
            }
            src = window.URL.createObjectURL(f);
            $('#'+liid+' img').attr('src', src);
            $('#'+liid).attr('name', 'block');

        }



        var prefix = ctx + "DS/product";

        $("#form-product-add").validate({
            focusCleanup: true
        });

        function submitHandler() {
            if ($.validate.form()) {
                uploadFile();
            }
        }

        function uploadFile() {
            var formData = new FormData();
            var Uarry=$("#ul-img li[name = block]");
            if (Uarry.length == 0){
                $.modal.alertWarning("最少上传一张商品图片");
                return false;
            }
            Uarry.each(function(){
                if ($(this).find('input')[0].files[0] != null) {
                    formData.append("file", $(this).find('input')[0].files[0]);
                }
                if ($(this).find('input')[0].files[0] == null){
                    if ($(this).find('img').attr('src') != ''){
                        formData.append('filepathes', $(this).find("img").attr("src"));
                    }
                }
            });
            $.ajax({
                url: prefix + "/getFileName",
                type: 'post',
                cache: false,
                data: formData,
                processData: false,
                contentType: false,
                dataType: "json",
                async: false,
                success: function (result) {
                    $.each(result, function (i, filename) {
                        formData.append('filepathes', filename);
                    })
                }
            });


            formData.append("skuMessages", 0)

            var i = $("head").attr('id');
            for (var j = 1; j < parseInt(i) ; j++) {
                var id = "form-productsku-add" + j;
                if ($("#" + id).css('display') == 'block') {
                    if (typeof($('#' + id + ' input[name = filePath]')[0].files[0]) == "undefined" && $('#'+ id +' img').attr('src') === "") {
                        $.modal.alertWarning("请为sku添加图片");
                        return false;
                    }

                    var skuMessages = {
                        size: $('#' + id + ' input[name = size]').val(),
                        color: $('#' + id + ' input[name = color]').val(),
                        suttle: $('#' + id + ' input[name = suttle]').val(),
                        rw: $('#' + id + ' input[name = rw]').val(),
                        costprice: $('#' + id + ' input[name = costprice]').val(),
                        sellprice: $('#' + id + ' input[name = sellprice]').val(),
                        state: $('#' + id + ' select[name = state]').select2('val'),
                        rank: $('#' + id + ' input[name = rank]').val(),
                        pd: $('#' + id + ' input[name = pd]').val(),
                        stt: $('#' + id + ' input[name = stt]').val(),
                        ips: $('#' + id + ' select[name = ips]').select2('val'),
                        product: $("#code").val(),
                        length: $('#' + id + ' input[name = length]').val(),
                        width: $('#' + id + ' input[name = width]').val(),
                        height: $('#' + id + ' input[name = height]').val(),
                        skumap: $('#' + id + ' input[name = skumap]').val(),
                        filepath: 0
                    }
                    var skufile = new FormData();
                    skufile.append('file', $('#'+id+' input[name = filePath]')[0].files[0]);
                    $.ajax({
                        url: prefix + "/getFileName",
                        type: 'post',
                        cache: false,
                        data:  skufile,
                        processData: false,
                        contentType: false,
                        dataType: "json",
                        async: false,
                        success: function (result) {
                            $.each(result, function (i, filename) {
                                skuMessages.filepath = filename
                            })
                        }
                    });

                    formData.append("skuMessages", JSON.stringify(skuMessages))
                }
            }

            formData.append('category', $("#category").val());
            formData.append('supplier', $("#supplier").val());
            formData.append('chinesename', $("#chinesename").val());
            formData.append('englishname', $("#englishname").val());
            formData.append('nocdc', $("#nocdc").val());
            formData.append('nocde', $("#nocde").val());
            formData.append('code', $("#code").val());
            formData.append('ocode', $("#ocode").val());
            formData.append('keyword', $("#keyword").val());
            formData.append('dd', $("#dd").val());
            formData.append('ordervalue', $("#ordervalue").val());
            $.ajax({
                url: prefix + "/add",
                type: 'post',
                cache: false,
                data: formData,
                processData: false,
                contentType: false,
                dataType: "json",
                async: false,
                success: function (result) {
                    if (self.frameElement.tagName == "IFRAME" && typeof (window.parent.refresh) == "function") {
                        // 在frame中时处理
                        $.modal.close();
                        window.parent.refresh();
                    } else {
                        $.operate.successTabCallback(result);
                    }
                }
            });
        }



    //    ajax 获取option
        function refresh() {
            $("#category").empty();
            $("#category").append("<option value=\"\">-----</option>");
            $("#supplier").empty();
            $("#supplier").append("<option value=\"\">-----</option>");
            $.get(prefix + "/refresh",function (result) {
                $.each(result,function (i, list) {
                    if(i == 0){
                        $.each(list,function (i,category) {
                            $("#category").append("<option value="+i+">"+i+":"+category+"</option>");
                        })
                    }else {
                        $.each(list,function (i,supplier) {
                            $("#supplier").append("<option value="+i+">"+i+":"+supplier+"</option>");
                        })
                    }
                })
            });
        }


        /*
       layer.open打开第三方添加界面
       */
        function layerOpenCategory() {
            layer.open({
                    type: 2,
                    title: "添加目录分类",
                    content: "/DS/category/add",
                    area: ['80%','80%']
                }
            )
        }


        /*
       layer.open打开第三方添加界面
       */
        function layerOpenSupplier() {
            layer.open({
                    type: 2,
                    title: "添加供应商",
                    content: "/DS/supplier/add",
                    area: ['80%','80%']
                }
            )
        }


        /*
        基本信息窗口打开关闭
         */
        function COWindow() {
            var show = $('#CO').css('display');
            if (show == "block") {
                // $('#CO').css('display', 'none');
                $("#CO").slideToggle('fast');
                $("#fa").attr('class', 'fa fa-chevron-down');
            }
            if (show == "none") {
                $("#CO").slideToggle('fast');
                // $('#CO').css('display', 'block');
                $("#fa").attr('class', 'fa fa-chevron-up');
            }
        }


        /*
            图片添加窗口打开关闭
        */
        function closeopenWindow() {
            var show = $('#CO2').css('display');
            if (show == "block") {
                // $('#CO').css('display', 'none');
                $("#CO2").slideToggle('fast');
                $("#fa2").attr('class', 'fa fa-chevron-down');
            }
            if (show == "none") {
                $("#CO2").slideToggle('fast');
                // $('#CO').css('display', 'block');
                $("#fa2").attr('class', 'fa fa-chevron-up');
            }
        }


        /*
        sku窗口打开关闭
         */
        function CO1Window() {
            var show = $('#CO1').css('display');
            if (show == "block") {
                // $('#CO').css('display', 'none');
                $("#CO1").slideToggle('fast');
                $("#fa1").attr('class', 'fa fa-chevron-down');
            }
            if (show == "none") {
                $("#CO1").slideToggle('fast');
                // $('#CO').css('display', 'block');
                $("#fa1").attr('class', 'fa fa-chevron-up');
            }
        }


        /*
        sku窗口增加操作
         */
        $("#sku").click(function addSku() {
            var number = $("head").attr('id');
            var skudivclone =$("#sku-div").clone(true);
            var idname = 'form-productsku-add'+number;
            var obj = "<label class=\"col-sm-3 control-label\">SKU主图：</label>\n" +
                "            <div class=\"col-sm-6\">\n" +
                "                <input name=\"filePath\" class=\"form-control onfile\" type=\"file\" onchange='viewImage("+JSON.stringify(idname)+")'><br>\n" +
                "            </div>";
            skudivclone.find("form").attr('id', idname);
            var skudiv = skudivclone.html();
            $("#sparkline8").append("<br><br><div class='row'><span class='col-md-1' style='color: #0d8ddb'>SKU单品项 #"+number+"</span> <div class='col-md-1 col-md-offset-10'><a class=\"close-link\"><i class=\"fa fa-times\" onclick='closeSku("+JSON.stringify(idname)+")'></i></a></div></div>");
            $("#sparkline8").append(skudiv);
            $("#"+idname+" div[name = appendObj]").append(obj);
            $("#"+idname+" input[name = stt]").datetimepicker({
                format: 'yyyy-mm-dd',
                autoclose: true,
                minView: 0,
                minuteStep:1,
                clearBtn: true,
                todayBtn: true
            });
            var show = $('#CO1').css('display');
            if (show == "none") {
                $("#CO1").slideToggle('fast');
                $("#fa1").attr('class', 'fa fa-chevron-up');
            }
            $("#"+idname+" select").select2();
            var number1 = parseInt(number) + 1;
            $("head").attr('id', number1);
            $("#"+idname+" .onfile").on('onchange', viewImage(JSON.stringify(idname)));
        })


        /*
        图片增加
         */
        $("#fa3").click(function adding() {
            var number = $("body").attr('id');
            var idname = 'hang'+number;
            var obj = "<li class=\"row\" id="+idname+" name=\"block\">\n" +
                "                                    <div class=\"col-md-5\">\n" +
                "                                        <label class=\"col-sm-3 control-label\" >图片路径：</label>\n" +
                "                                        <div class=\"col-sm-6\">\n" +
                "                                            <input  name=\"filePath\" class=\"form-control\" type=\"file\" onchange='viewImage("+JSON.stringify(idname)+")'>\n" +
                "                                        </div>\n" +
                "                                    </div>\n" +
                "                                    <div class=\"col-md-5\">\n" +
                "                                        <label class=\"col-sm-3 control-label\" >图片预览：</label>\n" +
                "                                        <div class=\"col-sm-6\">\n" +
                "                                            <img src=\"\" height=\"50\" width=\"50\" alt=\"Image preview area...\" title=\"preview-img\">\n" +
                "                                        </div>\n" +
                "                                    </div>\n" +
                "                                    <div id=\"table-td\" class=\"col-md-2\">\n" +
                "                                        <a class=\"close-link\"><i class=\"fa fa-times\" onclick='closeImg("+JSON.stringify(idname)+")'></i></a>\n" +
                "                                    </div>\n" +
                "                            </li>";
            $("#ul-img").append(obj);
            var number1 = parseInt(number) + 1;
            $("body").attr('id', number1);
        })


        Sortable.create(document.getElementById('ul-img'), {
            animation: 150,
            store: {//缓存到localStorage
                get: function(sortable) {
                    var order = localStorage.getItem(sortable.options.group);
                    return order ? order.split('|') : [];
                },
                set: function(sortable) {
                    var order = sortable.toArray();
                    localStorage.setItem(sortable.options.group, order.join('|'));
                }
            },
            onAdd: function(evt) {
                console.log('onAdd.foo:', [evt.item, evt.from]);
            },
            onUpdate: function(evt) {
                console.log('onUpdate.foo:', [evt.item, evt.from]);
            },
            onRemove: function(evt) {
                console.log('onRemove.foo:', [evt.item, evt.from]);
            },
            onStart: function(evt) {
                console.log('onStart.foo:', [evt.item, evt.from]);
            },
            onSort: function(evt) {
                console.log('onStart.foo:', [evt.item, evt.from]);
            },
            onEnd: function(evt) {
                console.log('onEnd.foo:', [evt.item, evt.from]);
            }
        });


        //关闭单项sku单品添加表单
        function closeSku(data) {
            $("#"+data).hide();
        }

        //关闭行图片添加表单
        function closeImg(data) {
                $("#"+data).attr('name', 'none');
                $("#"+data).hide();
        }
    </script>
</body>
</html>