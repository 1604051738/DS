<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head id="1">
    <meta http-equiv="Content-Type" content="multipart/form-data; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
    <th:block th:include="include :: header('新增商品')" />
    <th:block th:include="include :: select2-css" />
    <th:block th:include="include :: bootstrap-select-css" />
    <th:block th:include="include :: summernote-css" />
    <link rel="stylesheet" href="/css/upload.css">
</head>
<body class="white-bg" id="2">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content" style="height: auto; ">
        <div class="col-sm-12">
            <div class="ibox float-e-margins border-0">
                <div class="ibox-title">
                    <h5>商品基本信息</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up" id="fa" onclick="COWindow()"></i>
                        </a>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content text-center h-200" id="CO">
                    <span id="sparkline7">
                        <form class="form-horizontal m" id="form-product-add">

                            <div class="row show-grid ">
                                <div class="col-sm-6">
                                    <label class="col-sm-2 control-label">目录分类：</label>
                                    <div class="col-sm-7">
                                        <div class="input-group">
                                            <input id="treeId" name="parentdirectory" type="hidden" th:value="${category?.id}"/>
                                            <input class="form-control" type="text" onclick="selectCategoryTree()" id="treeName" readonly="true" th:value="${category?.name}">
                                            <span class="input-group-addon"><i class="fa fa-search"></i></span>
                                        </div>
                                    </div>
                                    <a class="btn btn-success col-sm-1" title="创建新的目录分类" onclick="layerOpenCategory()" ><i class="fa fa-plus"></i></a>
                                </div>

                                <div class="col-sm-6">
                                    <label class="col-sm-2 control-label">供应商：</label>
                                    <div class="col-sm-7">
                                        <select name="supplier" class="form-control m-b" id="supplier">
                                            <option value="">------</option>
                                        </select>
                                    </div>
                                    <a class="btn btn-success col-sm-1" title="创建新的供应商" onclick="layerOpenSupplier()" ><i class="fa fa-plus"></i></a>
                                </div>
                            </div>

                            <div class="row show-grid">
                                <div class="col-sm-12">
                                    <label class="col-sm-1 control-label"><span style="color: red; ">*</span>中文名称：</label>
                                    <div class="col-sm-10" >
                                        <input name="chinesename" id="chinesename" class="form-control" type="text" style="border-radius:9px" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row show-grid">
                            <div class="col-sm-12">
                                    <label class="col-sm-1 control-label">英文名称：</label>
                                    <div class="col-sm-10" >
                                        <input name="englishname" id="englishname" class="form-control" type="text" style="border-radius:9px">
                                    </div>
                                </div>
                            </div>
                            <div class="row show-grid">
                                <div class="col-sm-6">
                                    <label class="col-sm-2 control-label">报关名称中文：</label>
                                    <div class="col-sm-8" >
                                        <input name="nocdc" id="nocdc" class="form-control" type="text" style="border-radius:9px">
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <label class="col-sm-2 control-label">报关名称英文：</label>
                                    <div class="col-sm-8" >
                                        <input name="nocde" id="nocde" class="form-control" type="text" style="border-radius:9px">
                                    </div>
                                </div>
                            </div>


                        <div class="row show-grid">
                            <div class="col-sm-6">
                                <label class="col-sm-2 control-label"><span style="color: red; ">*</span>编码：</label>
                                <div class="col-sm-8">
                                    <input name="code" id="code" class="form-control" type="text" style="border-radius:9px" required>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                    <label class="col-sm-2 control-label">外部编码：</label>
                                    <div class="col-sm-8" >
                                        <input name="ocode" id="ocode" class="form-control" type="text" style="border-radius:9px">
                                    </div>
                            </div>
                        </div>

                        <div class="row show-grid">
                            <div class="col-sm-12">
                                    <label class="col-sm-1 control-label">关键字：</label>
                                    <div class="col-sm-10" >
                                        <input name="keyword" id="keyword" class="form-control" type="text" style="border-radius:9px">
                                    </div>
                            </div>
                        </div>

                        <div class="row show-grid">
                            <div class="col-sm-12" id="ddwindow">
                            <label class="col-sm-1 control-label">详细描述：</label>
                            <div class="col-sm-10" id="message" >
                                <div name="dd" id="summernote" class="form-control summernote" style="border-radius:9px"/>
                            </div>
                            </div>
                        </div>
                        </form>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>SKU单品</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-down" id="fa1" onclick="CO1Window()"></i>
                        </a>
                        <a>
                        <i class="fa fa-plus" id="sku"></i>
                        </a>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content text-center h-200" id="CO1" style="display: none">
                    <span id="sparkline8">
                    </span>
                </div>
            </div>
        </div>
    </div>




    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>商品图片</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up" ></i>
                        </a>
                        <a>
                            <i class="fa fa-plus" ></i>
                        </a>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content text-center h-200">
                    <label class="font-noraml">第一张图将作为商品预览图</label>
                        <div class="upload" id="ul-img" data-num="10" data-type="jpg,png" name="filePath"></div>
                </div>
            </div>
        </div>
    </div>


<!--    sku单品添加表单-->
    <div style="display: none" id="sku-div">
        <form class="form-horizontal m" style="display: block" enctype="multipart/form-data">
            <input class="h7" style="display: none" disabled>
            <hr>
            <div class="row show-grid">
                <div class="col-sm-4 imgDiv">
                    <label class="control-label">sku图片预览：</label>
                    <br/>
                        <img src="" height="100" width="100" alt="Image preview area..." title="preview-img" class="onimg" onclick="skuImageClick()">
                    <div name="appendObj">
                        <button type="button" onclick="$('#'+$(this).parent().parent().parent().parent().attr('id')+' input[name = filePath]').click()">选择文件</button>
                    </div>
                </div>

                <div class="col-sm-8">
                    <br/>
                    <div class="row">
                        <div class="col-sm-6">
                            <label class="col-sm-3 control-label">规格：</label>
                            <div class="col-sm-9">
                                <input name="size" id="size" class="form-control" type="text" style="border-radius:9px">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <label class="col-sm-3 control-label">颜色：</label>
                            <div class="col-sm-6">
                                <input name="color" id="color" class="form-control" type="text" style="border-radius:9px">
                            </div>
                        </div>
                    </div>

                    <br/>
                    <div class="row">
                        <div class="col-sm-6">
                            <label class="col-sm-4 control-label"><span style="color: red;">*</span>库存刊登策略：</label>
                            <div class="col-sm-6">
                                <select name="inventory_publish_policy" id="inventory_publish_policy" class="form-control m-b" required>
                                    <option value="1" selected>默认</option>
                                    <option value="2">按可售量</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <label class="col-sm-2 control-label">统计时间：</label>
                            <div class="col-sm-6">
                                <div class="input-group date">
                                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                    <input type="text" class="form-control datepicker hasDatepicker" id="sales_stat_time" placeholder="yyyy-MM-dd" name="sales_stat_time" data-format="yyyy-MM" style="border-radius:9px"/>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>

            </div>

            <div class="row show-grid">
                <input type="text" style="display:none;" name="code">
                <input type="text" style="display:none;" name="idcode">

                <div class="col-sm-3">
                    <label class="col-sm-4 control-label">净重：</label>
                    <div class="col-sm-6">
                        <input name="net_weight" id="net_weight" class="form-control" type="text" style="border-radius:9px">
                    </div>
                </div>
                <div class="col-sm-3">
                    <label class="col-sm-4 control-label"><span style="color: red; ">*</span>毛重：</label>
                    <div class="col-sm-6">
                        <input name="gross_weight" id="gross_weight" class="form-control" type="text" style="border-radius:9px" required>
                    </div>
                </div>
                <div class="col-sm-3">
                    <label class="col-sm-4 control-label"><span style="color: red; ">*</span>成本价(RMB)：</label>
                    <div class="col-sm-6">
                        <input name="cost_price" id="cost_price" class="form-control" type="text" style="border-radius:9px" required>
                    </div>
                </div>
                <div class="col-sm-3">
                    <label class="col-sm-4 control-label">售价：</label>
                    <div class="col-sm-6">
                        <input name="price" id="price" class="form-control" type="text" style="border-radius:9px">
                    </div>
                </div>
            </div>




            <div class="row show-grid">
                <div class="col-sm-6">
                    <label class="col-sm-2 control-label"><span style="color: red; ">*</span>状态：</label>
                    <div class="col-sm-6">
                        <select name="status" id="status" class="form-control m-b" style="border-radius:9px" required>
                            <option value="0" selected>非激活</option>
                            <option value="1">激活</option>
                            <option value="2">售完即止</option>
                        </select>
                    </div>
                </div>

                <div class="col-sm-6">
                    <label class="col-sm-2 control-label">采购交期：</label>
                    <div class="col-sm-6">
                        <input name="purchase_delivery_day" id="purchase_delivery_day" class="form-control" type="text" style="border-radius:9px">
                    </div>
                </div>
            </div>


            <div class="row show-grid">
                <div class="col-sm-4">
                    <label class="col-sm-3 control-label">长：</label>
                    <div class="col-sm-3">
                        <input name="length" id="length" class="form-control" type="text" style="border-radius:9px">
                    </div>
                </div>
                <div class="col-sm-4">
                    <label class="col-sm-3 control-label">宽：</label>
                    <div class="col-sm-3">
                        <input name="width" id="width" class="form-control" type="text" style="border-radius:9px">
                    </div>
                </div>

                <div class="col-sm-4">
                    <label class="col-sm-3 control-label">高：</label>
                    <div class="col-sm-3">
                        <input name="height" id="height" class="form-control" type="text" style="border-radius:9px">
                    </div>
                </div>
            </div>
            <hr>
        </form>
    </div>



    <div class="btn-group clearfix show-xs save-group col-sm-12">
        <div class="col-sm-offset-10 col-sm-10">
            <button type="button" class="default btn btn-primary hide-xs" onclick="submitHandler()"><i class="fa fa-check"></i>保 存</button>&nbsp;
            <button type="button" class="btn btn-default" onclick="closeItem()"><i class="fa fa-reply-all"></i>关 闭 </button>
        </div>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: select2-js" />
    <th:block th:include="include :: bootstrap-select-js" />
    <th:block th:include="include :: sparkline-js" />
    <th:block th:include="include :: summernote-js" />
    <th:block th:include="include :: datetimepicker-js" />
    <th:block th:include="include :: bootstrap-fileinput-js" />
    <script th:src="@{/ajax/libs/layui/layui.js}"></script>

    <script type="text/javascript" src="/js/jQuery.upload.js"></script>
    <script type="text/javascript">
        $().ready(function () {
                $('.summernote').summernote({
                    lang: 'zh-CN',
                    height: 400
                });
                $("#supplier").one("click", refresh());
                $("#sku-div select").select2("destroy");
                $("#ul-img").upload();
                if (screen.height > 860&&screen.height < 1081&&screen.width>1500&&screen.width<1921){
                    $(".show-grid").css('margin','0px 0');
                    $(".show-grid").css('border','0px');
                    $(".show-grid div[class^=col-]").css('height','55px');
                    $("#ddwindow").css('height','500px');
                    $(".imgDiv").css('height','150px');
                }
            });




        function viewImage(liid) {
            // 获取FileList的第一个元素
            liid = liid.toString().replace(/"/g,'');
            var f = $('#'+liid+' input[name = filePath]')[0].files[0];
            if(typeof (f) == 'undefined'){
                return false;
            }
            src = window.URL.createObjectURL(f);
            $('#'+liid+' img').attr('src', src);
            $('#'+liid).attr('name', 'block');

        }



        var prefix = ctx + "DS/product";

        $("#form-product-add").validate({
            focusCleanup: true
        });

        function submitHandler() {
            if ($.validate.form()) {
                uploadFile();
            }
        }

        function uploadFile() {
            var formData = new FormData();
            var Uarry=$("#ul-img .success");
            if (Uarry.length == 0){
                $.modal.alertWarning("最少上传一张商品图片");
                return false;
            }

            for(var i = 0; i<Uarry.length; i++){
                var dataUrl = Uarry[i].style.backgroundImage;
                var src = JSON.parse(dataUrl.split('(')[1].split(')')[0]);
                if (dataUrl.length > 200){
                    formData.append("file", dataURLtoFile(src, i));
                }else {
                    formData.append("filepathes", src);
                }
            }
            $.ajax({
                url: prefix + "/getFileName",
                type: 'post',
                cache: false,
                data: formData,
                processData: false,
                contentType: false,
                dataType: "json",
                async: false,
                success: function (result) {
                    $.each(result, function (i, filename) {
                        formData.append('filepathes', filename);
                    })
                }
            });

                /*
                 SKU商品信息
                 */
            formData.append("skuMessages", 0)

            var i = $("head").attr('id');
            for (var j = 1; j < parseInt(i) ; j++) {
                var id = "form-productsku-add" + j;
                if ($("#" + id).css('display') == 'block') {
                    if (typeof($('#' + id + ' input[name = filePath]')[0].files[0]) == "undefined" && $('#'+ id +' img').attr('src') === "") {
                        $.modal.alertWarning("请为sku添加图片");
                        return false;
                    }

                    var skuMessages = {
                        size: $('#' + id + ' input[name = size]').val(),
                        color: $('#' + id + ' input[name = color]').val(),
                        netWeight: $('#' + id + ' input[name = net_weight]').val(),
                        code: $('#' + id + ' input[name = code]').val(),
                        grossWeight: $('#' + id + ' input[name = gross_weight]').val(),
                        costPrice: $('#' + id + ' input[name = cost_price]').val(),
                        price: $('#' + id + ' input[name = price]').val(),
                        status: $('#' + id + ' select[name = status]').find("option:selected").attr("value"),
                        rank: $('#' + id + ' input[name = rank]').val(),
                        purchaseDeliveryDay: $('#' + id + ' input[name = purchase_delivery_day]').val(),
                        salesStatTime: $('#' + id + ' input[name = sales_stat_time]').val().substr(0,10),
                        inventoryPublishPolicy: $('#' + id + ' select[name = inventory_publish_policy]').val(),
                        length: $('#' + id + ' input[name = length]').val(),
                        width: $('#' + id + ' input[name = width]').val(),
                        height: $('#' + id + ' input[name = height]').val(),
                        filepath: 0
                    }
                    var skufile = new FormData();
                    skufile.append('file', $('#'+id+' input[name = filePath]')[0].files[0]);
                    $.ajax({
                        url: prefix + "/getFileName",
                        type: 'post',
                        cache: false,
                        data:  skufile,
                        processData: false,
                        contentType: false,
                        dataType: "json",
                        async: false,
                        success: function (result) {
                            $.each(result, function (i, filename) {
                                skuMessages.filepath = filename
                            })
                        }
                    });

                    formData.append("skuMessages", JSON.stringify(skuMessages))
                }
            }

            formData.append('category', $("#treeId").val());
            formData.append('supplier', $("#supplier").val());
            formData.append('chinesename', $("#chinesename").val());
            formData.append('englishname', $("#englishname").val());
            formData.append('nocdc', $("#nocdc").val());
            formData.append('nocde', $("#nocde").val());
            formData.append('code', $("#code").val());
            formData.append('ocode', $("#ocode").val());
            formData.append('keyword', $("#keyword").val());
            /*
                详细描述信息
             */

            var formData1 = new FormData();
            $.each($("#summernote").next().find("img"),function(i,result){
                var dataUrl = $("#summernote").next().find("img")[i].src;
                formData1.append("file", dataURLtoFile(dataUrl, i));
            });
            $.ajax({
                url: prefix + "/getFileName",
                type: 'post',
                cache: false,
                data: formData1,
                processData: false,
                contentType: false,
                dataType: "json",
                async: false,
                success: function (result) {
                    $.each(result, function (i, filename) {
                        $("#summernote").next().find("img")[i].src = filename;
                    })
                }
            });


            formData.append('dd', $("#summernote").summernote("code"));
            formData.append('ordervalue', $("#ordervalue").val());
            $.ajax({
                url: prefix + "/add",
                type: 'post',
                cache: false,
                data: formData,
                processData: false,
                contentType: false,
                dataType: "json",
                async: false,
                success: function (result) {
                    if (self.frameElement.tagName == "IFRAME" && typeof (window.parent.refresh) == "function") {
                        // 在frame中时处理
                        $.modal.close();
                        window.parent.refresh();
                    } else {
                        $.operate.successTabCallback(result);
                    }
                }
            });
        }



    //    ajax 获取option
        function refresh() {
            $("#supplier").empty();
            $("#supplier").append("<option value=\"\">-----</option>");
            $.get(prefix + "/refresh",function (result) {
                $.each(result,function (i, data) {
                    $.each(data,function (i,supplier) {
                        $("#supplier").append("<option value="+supplier.id+">"+supplier.name+"</option>");
                    })
                })
            });
        }


        /*
       layer.open打开第三方添加界面
       */
        function layerOpenCategory() {
            layer.open({
                    type: 2,
                    title: "添加目录分类",
                    content: "/DS/category/add/",
                    area: ['80%','80%']
                }
            )
        }


        /*
       layer.open打开第三方添加界面
       */
        function layerOpenSupplier() {
            layer.open({
                    type: 2,
                    title: "添加供应商",
                    content: "/DS/supplier/add",
                    area: ['80%','80%']
                }
            )
        }


        /*
        基本信息窗口打开关闭
         */
        function COWindow() {
            var show = $('#CO').css('display');
            if (show == "block") {
                // $('#CO').css('display', 'none');
                $("#CO").slideToggle('fast');
                $("#fa").attr('class', 'fa fa-chevron-down');
            }
            if (show == "none") {
                $("#CO").slideToggle('fast');
                // $('#CO').css('display', 'block');
                $("#fa").attr('class', 'fa fa-chevron-up');
            }
        }




        /*
        sku窗口打开关闭
         */
        function CO1Window() {
            var show = $('#CO1').css('display');
            if (show == "block") {
                // $('#CO').css('display', 'none');
                $("#CO1").slideToggle('fast');
                $("#fa1").attr('class', 'fa fa-chevron-down');
            }
            if (show == "none") {
                $("#CO1").slideToggle('fast');
                // $('#CO').css('display', 'block');
                $("#fa1").attr('class', 'fa fa-chevron-up');
            }
        }


        /*
        sku窗口增加操作
         */
        $("#sku").click(function addSku() {
            var number = $("head").attr('id');
            var skudivclone =$("#sku-div").clone(true);
            var idname = 'form-productsku-add'+number;
            var obj = "<input name=\"filePath\" class=\"form-control onfile\" type=\"file\" onchange='viewImage("+JSON.stringify(idname)+")' style=\"display: none\"><br>\n";
            skudivclone.find("form").attr('id', idname);
            var skudiv = skudivclone.html();
            $("#sparkline8").append("<br><br><div class='row'><span class='col-sm-1' style='color: #0d8ddb'>SKU单品项 #"+number+"</span> <div class='col-sm-1 col-sm-offset-10'><a class=\"close-link\"><i class=\"fa fa-times\" onclick='closeSku("+JSON.stringify(idname)+")'></i></a></div></div>");
            $("#sparkline8").append(skudiv);
            $("#"+idname+" div[name = appendObj]").append(obj);
            $("#"+idname+" input[name = sales_stat_time]").datetimepicker({
                format: 'yyyy-mm-dd hh:ii:ss',
                autoclose: true,
                minView: 0,
                minuteStep:1,
                clearBtn: true,
                todayBtn: true
            });
            var show = $('#CO1').css('display');
            if (show == "none") {
                $("#CO1").slideToggle('fast');
                $("#fa1").attr('class', 'fa fa-chevron-up');
            }
            var number1 = parseInt(number) + 1;
            $("head").attr('id', number1);
            $("#"+idname+" .onfile").on('onchange', viewImage(JSON.stringify(idname)));
        });


        /**
         * fileinput批量上传图片
         */
        $(".file").fileinput({
            'theme': 'explorer-fas',
            'uploadUrl': '#',
            ovegross_weightriteInitial: false,
            initialPreviewAsData: true,
            showRemove: true,
            deleteUrl:'#',
            uploadAsync: true,
        })




        //关闭单项sku单品添加表单
        function closeSku(data) {
            $("#"+data).hide();
        }

        //关闭行图片添加表单
        function closeImg(data) {
                $("#"+data).attr('name', 'none');
                $("#"+data).hide();
        }


        //将base64转换为文件对象
        function dataURLtoFile(dataurl, filename) {
            var arr = dataurl.split(',');
            var mime = arr[0].match(/:(.*?);/)[1];
            var bstr = atob(arr[1]);
            var n = bstr.length;
            var u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            //转换成file对象
            return new File([u8arr], filename, {type:mime});
        }


        /*目录分类-新增-选择父部门树*/
        function selectCategoryTree() {
            var options = {
                title: '目录分类选择',
                width: "380",
                url: ctx+"DS/category/selectCategoryTree/" + $("#treeId").val(),
                callBack: doSubmit
            };
            $.modal.openOptions(options);
        }

        function doSubmit(index, layero){
            var body = layer.getChildFrame('body', index);
            $("#treeId").val(body.find('#treeId').val());
            $("#treeName").val(body.find('#treeName').val());
            layer.close(index);
        }
    </script>
</body>
</html>